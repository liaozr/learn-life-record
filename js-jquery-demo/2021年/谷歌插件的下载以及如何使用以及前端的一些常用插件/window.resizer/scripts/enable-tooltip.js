/// <reference path="../../typings/html5.d.ts" />
(function (context) {
    const POSITIONS = {
        center: 0,
        top: -1,
        left: -1,
        bottom: 1,
        right: 1,
    };
    const CONFIG = {
        WrapperID: 'window_resizer_tooltip_wrapper',
        HideTimeout: 2000,
        ZoomFactor: 1,
        Position: ['bottom', 'right']
    };
    const SLOTS = {
        WindowWidth: null,
        WindowHeight: null,
        ViewportWidth: null,
        ViewportHeight: null,
        CloseButton: null,
        SettingsButton: null
    };
    const STATE = {
        NeedsUpdate: false,
        PendingHide: null
    };
    const Runtime = {
        addEventListener: function (listener) {
            !chrome.runtime.onMessage.hasListener(listener)
                && chrome.runtime.onMessage.addListener(listener);
        },
        removeEventListener: function (listener) {
            try {
                chrome.runtime.onMessage.removeListener(listener);
            }
            catch (ex) { }
        },
        invoke: function (action, parameters) {
            return new Promise((resolve, reject) => {
                chrome.runtime.sendMessage({ action, parameters }, resolve);
            });
        },
        getURL: function (asset) {
            return chrome.extension.getURL(asset);
        }
    };
    let Tooltip = document.getElementById(CONFIG.WrapperID);
    Tooltip && Tooltip.remove();
    Promise.all([
        Runtime.invoke('tooltip-hide-delay'),
        Runtime.invoke('tooltip-position'),
        Runtime.invoke('get-zoom')
    ]).then(([delay, position, zoom]) => {
        CONFIG.HideTimeout = delay.data;
        CONFIG.Position = (position.data && position.data.length == 2) ? position.data : CONFIG.Position;
        CONFIG.ZoomFactor = context.devicePixelRatio / zoom.data;
        _init();
    });
    function _init() {
        let link = document.createElement('link');
        link.addEventListener('load', e => {
            Tooltip = document.createElement('div');
            Tooltip.id = CONFIG.WrapperID;
            Tooltip.setAttribute('data-pos-y', CONFIG.Position[0]);
            Tooltip.setAttribute('data-pos-x', CONFIG.Position[1]);
            let template = link.import.querySelector('template');
            let ShadowRoot = Tooltip.createShadowRoot();
            ShadowRoot.appendChild(document.importNode(template.content, true));
            ShadowRoot.querySelector('.logo').addEventListener('mousedown', _dragStart);
            SLOTS.WindowWidth = ShadowRoot.querySelector('.primary .width');
            SLOTS.WindowHeight = ShadowRoot.querySelector('.primary .height');
            SLOTS.ViewportWidth = ShadowRoot.querySelector('.secondary .width');
            SLOTS.ViewportHeight = ShadowRoot.querySelector('.secondary .height');
            SLOTS.CloseButton = ShadowRoot.querySelector('.close');
            SLOTS.SettingsButton = ShadowRoot.querySelector('.settings');
            document.body.appendChild(Tooltip);
            enable();
            function _dragStart(evt) {
                Tooltip.classList.add('dragging');
                document.addEventListener('mousemove', _dragUpdate);
                document.addEventListener('mouseup', _dragEnd);
                document.body.style.cursor = 'move';
            }
            function _dragEnd(evt) {
                Tooltip.classList.remove('dragging');
                document.removeEventListener('mousemove', _dragUpdate);
                document.removeEventListener('mouseup', _dragEnd);
                document.body.style.cursor = 'initial';
                Runtime.invoke('save-settings', {
                    tooltipPosition: CONFIG.Position
                });
            }
            function _dragUpdate(evt) {
                if (!evt.clientX && !evt.clientY) {
                    return;
                }
                evt.stopPropagation();
                evt.preventDefault();
                let xSegment = window.innerWidth / 3;
                let ySegment = window.innerHeight / 3;
                let xAxis = 'left';
                let yAxis = 'top';
                if (evt.clientX > xSegment * 1)
                    xAxis = 'center';
                if (evt.clientX > xSegment * 2)
                    xAxis = 'right';
                if (evt.clientY > ySegment * 1)
                    yAxis = 'center';
                if (evt.clientY > ySegment * 2)
                    yAxis = 'bottom';
                CONFIG.Position[0] != yAxis && Tooltip.setAttribute('data-pos-y', yAxis);
                CONFIG.Position[1] != xAxis && Tooltip.setAttribute('data-pos-x', xAxis);
                if (CONFIG.Position[0] != yAxis || CONFIG.Position[1] != xAxis) {
                    CONFIG.Position = [yAxis, xAxis];
                    Tooltip.style.transform = _getTransform();
                }
            }
        });
        link.rel = 'import';
        link.href = Runtime.getURL('assets/tpl/resize-tooltip.html');
        // Apparently Chrome crashes when injecting an `import` link into the
        // document before the `readyState` is "complete"
        // (found on Google Drive)
        function _inject() {
            if (document.readyState === 'complete') {
                document.removeEventListener('readystatechange', _inject);
                document.querySelector('head').appendChild(link);
            }
        }
        if (document.readyState !== 'complete') {
            document.addEventListener('readystatechange', _inject);
        }
        else {
            _inject();
        }
    }
    function _toggleEventListeners(state) {
        let action = state ? 'addEventListener' : 'removeEventListener';
        Runtime[action](handleExtensionRequest);
        context[action]('resize', update, false);
        Tooltip[action]('mouseover', showOn);
        Tooltip[action]('mouseout', delayedHide);
        SLOTS.CloseButton[action]('click', disable);
        SLOTS.SettingsButton[action]('click', openSettings);
    }
    function _getTransform() {
        const scale = CONFIG.ZoomFactor / context.devicePixelRatio;
        const posY = POSITIONS[CONFIG.Position[0]];
        const posX = POSITIONS[CONFIG.Position[1]];
        let left = posX * -24 + window.innerWidth / scale * (posX + 1) / 2 - Tooltip.offsetWidth / scale * (posX + 1) / 2;
        let top = posY * -24 + window.innerHeight / scale * (posY + 1) / 2 - Tooltip.offsetHeight / scale * (posY + 1) / 2;
        return `scale(${scale}) translateY(${top}px) translateX(${left}px)`;
    }
    function enable() {
        // read the opacity to kick-start the initial CSS fade-in animation
        // (it wouldn't otherwise animate when adding the `.visible` class right after
        // appending the node to the body - most likely because of some Chrome bug)
        context.getComputedStyle(Tooltip).opacity;
        _toggleEventListeners(true);
        //show();
    }
    function disable() {
        _toggleEventListeners(false);
        hide().then(() => {
            Tooltip.remove();
            Tooltip = null;
        });
    }
    function openSettings() {
        Runtime.invoke('open-settings', '#settings/tooltip');
    }
    function show(autoHide) {
        Tooltip.classList.add('visible');
        cancelDelayedHide();
        update();
        autoHide !== false && delayedHide();
    }
    function showOn() {
        show(false);
    }
    function hide() {
        Tooltip.classList.remove('visible');
        cancelDelayedHide();
        STATE.NeedsUpdate = false;
        return new Promise((done) => setTimeout(done, 300));
    }
    function delayedHide() {
        cancelDelayedHide();
        STATE.PendingHide = setTimeout(hide, CONFIG.HideTimeout);
    }
    function cancelDelayedHide() {
        clearTimeout(STATE.PendingHide);
        STATE.PendingHide = null;
    }
    function update() {
        if (!Tooltip.parentNode) {
            disable();
            return;
        }
        if (!STATE.NeedsUpdate) {
            STATE.NeedsUpdate = true;
            context.requestAnimationFrame(_update);
        }
    }
    function _update() {
        STATE.NeedsUpdate = false;
        Tooltip.style.transform = _getTransform();
        SLOTS.WindowWidth.innerHTML = context.innerWidth;
        SLOTS.WindowHeight.innerHTML = context.innerHeight;
        SLOTS.ViewportWidth.innerHTML = context.outerWidth;
        SLOTS.ViewportHeight.innerHTML = context.outerHeight;
        !isVisible() && show();
    }
    function isVisible() {
        return Tooltip && Tooltip.classList.contains('visible');
    }
    function handleExtensionRequest(msg, sender, respond) {
        if (typeof msg === 'string') {
            msg = { command: msg };
        }
        switch (msg.command) {
            case 'STATUS':
                respond(isVisible() ? 'VISIBLE' : 'HIDDEN');
                break;
            case 'SET_HIDE_DELAY':
                CONFIG.HideTimeout = msg.delay || CONFIG.HideTimeout;
                break;
            case 'DISABLE':
                disable();
                break;
            case 'SHOW':
                show();
                break;
            case 'HIDE':
                hide();
                break;
            case 'TOGGLE':
                isVisible() ? hide() : show();
                break;
        }
    }
})(this);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9TY3JpcHRzL2VuYWJsZS10b29sdGlwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUVqRCxDQUFDLFVBQVMsT0FBTztJQUNoQixNQUFNLFNBQVMsR0FBRztRQUNqQixNQUFNLEVBQUcsQ0FBQztRQUNWLEdBQUcsRUFBTSxDQUFDLENBQUM7UUFDWCxJQUFJLEVBQUssQ0FBQyxDQUFDO1FBQ1gsTUFBTSxFQUFHLENBQUM7UUFDVixLQUFLLEVBQUksQ0FBQztLQUNWLENBQUE7SUFFRCxNQUFNLE1BQU0sR0FBRztRQUNkLFNBQVMsRUFBSyxnQ0FBZ0M7UUFDOUMsV0FBVyxFQUFHLElBQUk7UUFDbEIsVUFBVSxFQUFJLENBQUM7UUFDZixRQUFRLEVBQU0sQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDO0tBQ2pDLENBQUM7SUFFRixNQUFNLEtBQUssR0FBRztRQUNiLFdBQVcsRUFBTSxJQUFJO1FBQ3JCLFlBQVksRUFBSyxJQUFJO1FBQ3JCLGFBQWEsRUFBSSxJQUFJO1FBQ3JCLGNBQWMsRUFBRyxJQUFJO1FBQ3JCLFdBQVcsRUFBTSxJQUFJO1FBQ3JCLGNBQWMsRUFBRyxJQUFJO0tBQ3JCLENBQUM7SUFFRixNQUFNLEtBQUssR0FBRztRQUNiLFdBQVcsRUFBRyxLQUFLO1FBQ25CLFdBQVcsRUFBRyxJQUFJO0tBQ2xCLENBQUE7SUFFRCxNQUFNLE9BQU8sR0FBRztRQUNmLGdCQUFnQixFQUFFLFVBQVMsUUFBUTtZQUNsQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7bUJBQzNDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBRUQsbUJBQW1CLEVBQUUsVUFBUyxRQUFRO1lBQ3JDLElBQUksQ0FBQztnQkFDSixNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENB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T0FBTyxHQUFHLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM3QixHQUFHLEdBQUcsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUE7UUFDckIsQ0FBQztRQUVELE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLEtBQUssUUFBUTtnQkFDWixPQUFPLENBQUMsU0FBUyxFQUFFLEdBQUcsU0FBUyxHQUFHLFFBQVEsQ0FBQyxDQUFDO2dCQUM3QyxLQUFLLENBQUM7WUFFTixLQUFLLGdCQUFnQjtnQkFDcEIsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELEtBQUssQ0FBQztZQUVOLEtBQUssU0FBUztnQkFDYixPQUFPLEVBQUUsQ0FBQztnQkFDWCxLQUFLLENBQUM7WUFFTixLQUFLLE1BQU07Z0JBQ1YsSUFBSSxFQUFFLENBQUM7Z0JBQ1IsS0FBSyxDQUFDO1lBRU4sS0FBSyxNQUFNO2dCQUNWLElBQUksRUFBRSxDQUFDO2dCQUNSLEtBQUssQ0FBQztZQUVOLEtBQUssUUFBUTtnQkFDWixTQUFTLEVBQUUsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQztnQkFDL0IsS0FBSyxDQUFDO1FBQ1AsQ0FBQztJQUNGLENBQUM7QUFDRixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyIsImZpbGUiOiJzY3JpcHRzL2VuYWJsZS10b29sdGlwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL3R5cGluZ3MvaHRtbDUuZC50c1wiIC8+XHJcblxyXG4oZnVuY3Rpb24oY29udGV4dCkge1xyXG5cdGNvbnN0IFBPU0lUSU9OUyA9IHtcclxuXHRcdGNlbnRlciA6IDAsXHJcblx0XHR0b3AgICAgOiAtMSxcclxuXHRcdGxlZnQgICA6IC0xLFxyXG5cdFx0Ym90dG9tIDogMSxcclxuXHRcdHJpZ2h0ICA6IDEsXHJcblx0fVxyXG5cclxuXHRjb25zdCBDT05GSUcgPSB7XHJcblx0XHRXcmFwcGVySUQgICA6ICd3aW5kb3dfcmVzaXplcl90b29sdGlwX3dyYXBwZXInLFxyXG5cdFx0SGlkZVRpbWVvdXQgOiAyMDAwLFxyXG5cdFx0Wm9vbUZhY3RvciAgOiAxLFxyXG5cdFx0UG9zaXRpb24gICAgOiBbJ2JvdHRvbScsICdyaWdodCddXHJcblx0fTtcclxuXHJcblx0Y29uc3QgU0xPVFMgPSB7XHJcblx0XHRXaW5kb3dXaWR0aCAgICA6IG51bGwsXHJcblx0XHRXaW5kb3dIZWlnaHQgICA6IG51bGwsXHJcblx0XHRWaWV3cG9ydFdpZHRoICA6IG51bGwsXHJcblx0XHRWaWV3cG9ydEhlaWdodCA6IG51bGwsXHJcblx0XHRDbG9zZUJ1dHRvbiAgICA6IG51bGwsXHJcblx0XHRTZXR0aW5nc0J1dHRvbiA6IG51bGxcclxuXHR9O1xyXG5cclxuXHRjb25zdCBTVEFURSA9IHtcclxuXHRcdE5lZWRzVXBkYXRlIDogZmFsc2UsXHJcblx0XHRQZW5kaW5nSGlkZSA6IG51bGxcclxuXHR9XHJcblxyXG5cdGNvbnN0IFJ1bnRpbWUgPSB7XHJcblx0XHRhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbihsaXN0ZW5lcikge1xyXG5cdFx0XHQhY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmhhc0xpc3RlbmVyKGxpc3RlbmVyKVxyXG5cdFx0XHRcdCYmIGNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcihsaXN0ZW5lcik7XHJcblx0XHR9LFxyXG5cclxuXHRcdHJlbW92ZUV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKGxpc3RlbmVyKSB7XHJcblx0XHRcdHRyeSB7XHJcblx0XHRcdFx0Y2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLnJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyKTtcclxuXHRcdFx0fSBjYXRjaCAoZXgpIHt9XHJcblx0XHR9LFxyXG5cclxuXHRcdGludm9rZTogZnVuY3Rpb24oYWN0aW9uLCBwYXJhbWV0ZXJzPykge1xyXG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cdFx0XHRcdGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHthY3Rpb24sIHBhcmFtZXRlcnN9LCByZXNvbHZlKTtcclxuXHRcdFx0fSlcclxuXHRcdH0sXHJcblxyXG5cdFx0Z2V0VVJMOiBmdW5jdGlvbihhc3NldCkge1xyXG5cdFx0XHRyZXR1cm4gY2hyb21lLmV4dGVuc2lvbi5nZXRVUkwoYXNzZXQpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0bGV0IFRvb2x0aXA6IEhUTUxFbGVtZW50ID0gPEhUTUxFbGVtZW50PiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChDT05GSUcuV3JhcHBlcklEKTtcclxuXHJcblx0VG9vbHRpcCAmJiBUb29sdGlwLnJlbW92ZSgpO1xyXG5cclxuXHRQcm9taXNlLmFsbChbXHJcblx0XHRSdW50aW1lLmludm9rZSgndG9vbHRpcC1oaWRlLWRlbGF5JyksXHJcblx0XHRSdW50aW1lLmludm9rZSgndG9vbHRpcC1wb3NpdGlvbicpLFxyXG5cdFx0UnVudGltZS5pbnZva2UoJ2dldC16b29tJylcclxuXHRdKS50aGVuKChbZGVsYXksIHBvc2l0aW9uLCB6b29tXTogYW55KSA9PiB7XHJcblx0XHRDT05GSUcuSGlkZVRpbWVvdXQgPSBkZWxheS5kYXRhO1xyXG5cdFx0Q09ORklHLlBvc2l0aW9uICAgID0gKHBvc2l0aW9uLmRhdGEgJiYgcG9zaXRpb24uZGF0YS5sZW5ndGggPT0gMikgPyBwb3NpdGlvbi5kYXRhIDogQ09ORklHLlBvc2l0aW9uO1xyXG5cdFx0Q09ORklHLlpvb21GYWN0b3IgID0gY29udGV4dC5kZXZpY2VQaXhlbFJhdGlvIC8gem9vbS5kYXRhO1xyXG5cclxuXHRcdF9pbml0KCk7XHJcblx0fSk7XHJcblxyXG5cdGZ1bmN0aW9uIF9pbml0KCkge1xyXG5cdFx0bGV0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7XHJcblx0XHRsaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBlID0+IHtcclxuXHRcdFx0VG9vbHRpcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG5cdFx0XHRUb29sdGlwLmlkID0gQ09ORklHLldyYXBwZXJJRDtcclxuXHRcdFx0VG9vbHRpcC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcG9zLXknLCBDT05GSUcuUG9zaXRpb25bMF0pO1xyXG5cdFx0XHRUb29sdGlwLnNldEF0dHJpYnV0ZSgnZGF0YS1wb3MteCcsIENPTkZJRy5Qb3NpdGlvblsxXSk7XHJcblxyXG5cdFx0XHRsZXQgdGVtcGxhdGUgPSA8SFRNTFRlbXBsYXRlRWxlbWVudD4gbGluay5pbXBvcnQucXVlcnlTZWxlY3RvcigndGVtcGxhdGUnKTtcclxuXHRcdFx0bGV0IFNoYWRvd1Jvb3QgPSBUb29sdGlwLmNyZWF0ZVNoYWRvd1Jvb3QoKTtcclxuXHJcblx0XHRcdFNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuaW1wb3J0Tm9kZSh0ZW1wbGF0ZS5jb250ZW50LCB0cnVlKSk7XHJcblx0XHRcdFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLmxvZ28nKS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBfZHJhZ1N0YXJ0KTtcclxuXHJcblx0XHRcdFNMT1RTLldpbmRvd1dpZHRoICAgID0gU2hhZG93Um9vdC5xdWVyeVNlbGVjdG9yKCcucHJpbWFyeSAud2lkdGgnKTtcclxuXHRcdFx0U0xPVFMuV2luZG93SGVpZ2h0ICAgPSBTaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IoJy5wcmltYXJ5IC5oZWlnaHQnKTtcclxuXHRcdFx0U0xPVFMuVmlld3BvcnRXaWR0aCAgPSBTaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IoJy5zZWNvbmRhcnkgLndpZHRoJyk7XHJcblx0XHRcdFNMT1RTLlZpZXdwb3J0SGVpZ2h0ID0gU2hhZG93Um9vdC5xdWVyeVNlbGVjdG9yKCcuc2Vjb25kYXJ5IC5oZWlnaHQnKTtcclxuXHRcdFx0U0xPVFMuQ2xvc2VCdXR0b24gICAgPSBTaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IoJy5jbG9zZScpO1xyXG5cdFx0XHRTTE9UUy5TZXR0aW5nc0J1dHRvbiA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLnNldHRpbmdzJyk7XHJcblxyXG5cdFx0XHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKFRvb2x0aXApO1xyXG5cdFx0XHRlbmFibGUoKTtcclxuXHJcblx0XHRcdGZ1bmN0aW9uIF9kcmFnU3RhcnQoZXZ0KSB7XHJcblx0XHRcdFx0VG9vbHRpcC5jbGFzc0xpc3QuYWRkKCdkcmFnZ2luZycpO1xyXG5cdFx0XHRcdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIF9kcmFnVXBkYXRlKTtcclxuXHRcdFx0XHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgX2RyYWdFbmQpO1xyXG5cdFx0XHRcdGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ21vdmUnO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRmdW5jdGlvbiBfZHJhZ0VuZChldnQpIHtcclxuXHRcdFx0XHRUb29sdGlwLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7XHJcblx0XHRcdFx0ZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgX2RyYWdVcGRhdGUpO1xyXG5cdFx0XHRcdGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBfZHJhZ0VuZCk7XHJcblx0XHRcdFx0ZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnaW5pdGlhbCc7XHJcblxyXG5cdFx0XHRcdFJ1bnRpbWUuaW52b2tlKCdzYXZlLXNldHRpbmdzJywge1xyXG5cdFx0XHRcdFx0dG9vbHRpcFBvc2l0aW9uOiBDT05GSUcuUG9zaXRpb25cclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0ZnVuY3Rpb24gX2RyYWdVcGRhdGUoZXZ0KSB7XHJcblx0XHRcdFx0aWYgKCFldnQuY2xpZW50WCAmJiAhZXZ0LmNsaWVudFkpIHtcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGV2dC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRcdFx0XHRldnQucHJldmVudERlZmF1bHQoKTtcclxuXHJcblx0XHRcdFx0bGV0IHhTZWdtZW50ID0gd2luZG93LmlubmVyV2lkdGggLyAzO1xyXG5cdFx0XHRcdGxldCB5U2VnbWVudCA9IHdpbmRvdy5pbm5lckhlaWdodCAvIDM7XHJcblx0XHRcdFx0bGV0IHhBeGlzICAgID0gJ2xlZnQnO1xyXG5cdFx0XHRcdGxldCB5QXhpcyAgICA9ICd0b3AnO1xyXG5cclxuXHRcdFx0XHRpZiAoZXZ0LmNsaWVudFggPiB4U2VnbWVudCAqIDEpIHhBeGlzID0gJ2NlbnRlcic7XHJcblx0XHRcdFx0aWYgKGV2dC5jbGllbnRYID4geFNlZ21lbnQgKiAyKSB4QXhpcyA9ICdyaWdodCc7XHJcblxyXG5cdFx0XHRcdGlmIChldnQuY2xpZW50WSA+IHlTZWdtZW50ICogMSkgeUF4aXMgPSAnY2VudGVyJztcclxuXHRcdFx0XHRpZiAoZXZ0LmNsaWVudFkgPiB5U2VnbWVudCAqIDIpIHlBeGlzID0gJ2JvdHRvbSc7XHJcblxyXG5cdFx0XHRcdENPTkZJRy5Qb3NpdGlvblswXSAhPSB5QXhpcyAmJiBUb29sdGlwLnNldEF0dHJpYnV0ZSgnZGF0YS1wb3MteScsIHlBeGlzKTtcclxuXHRcdFx0XHRDT05GSUcuUG9zaXRpb25bMV0gIT0geEF4aXMgJiYgVG9vbHRpcC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcG9zLXgnLCB4QXhpcyk7XHJcblxyXG5cdFx0XHRcdGlmIChDT05GSUcuUG9zaXRpb25bMF0gIT0geUF4aXMgfHwgQ09ORklHLlBvc2l0aW9uWzFdICE9IHhBeGlzKSB7XHJcblx0XHRcdFx0XHRDT05GSUcuUG9zaXRpb24gPSBbeUF4aXMsIHhBeGlzXTtcclxuXHRcdFx0XHRcdFRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gX2dldFRyYW5zZm9ybSgpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblxyXG5cdFx0bGluay5yZWwgID0gJ2ltcG9ydCc7XHJcblx0XHRsaW5rLmhyZWYgPSBSdW50aW1lLmdldFVSTCgnYXNzZXRzL3RwbC9yZXNpemUtdG9vbHRpcC5odG1sJyk7XHJcblxyXG5cdFx0Ly8gQXBwYXJlbnRseSBDaHJvbWUgY3Jhc2hlcyB3aGVuIGluamVjdGluZyBhbiBgaW1wb3J0YCBsaW5rIGludG8gdGhlXHJcblx0XHQvLyBkb2N1bWVudCBiZWZvcmUgdGhlIGByZWFkeVN0YXRlYCBpcyBcImNvbXBsZXRlXCJcclxuXHRcdC8vIChmb3VuZCBvbiBHb29nbGUgRHJpdmUpXHJcblx0XHRmdW5jdGlvbiBfaW5qZWN0KCkge1xyXG5cdFx0XHRpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykge1xyXG5cdFx0XHRcdGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBfaW5qZWN0KTtcclxuXHRcdFx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJykuYXBwZW5kQ2hpbGQobGluayk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gJ2NvbXBsZXRlJykge1xyXG5cdFx0XHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgX2luamVjdCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRfaW5qZWN0KCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBfdG9nZ2xlRXZlbnRMaXN0ZW5lcnMoc3RhdGUpIHtcclxuXHRcdGxldCBhY3Rpb24gPSBzdGF0ZSA/ICdhZGRFdmVudExpc3RlbmVyJyA6ICdyZW1vdmVFdmVudExpc3RlbmVyJztcclxuXHJcblx0XHRSdW50aW1lW2FjdGlvbl0oaGFuZGxlRXh0ZW5zaW9uUmVxdWVzdCk7XHJcblx0XHRjb250ZXh0W2FjdGlvbl0oJ3Jlc2l6ZScsIHVwZGF0ZSwgZmFsc2UpO1xyXG5cdFx0VG9vbHRpcFthY3Rpb25dKCdtb3VzZW92ZXInLCBzaG93T24pO1xyXG5cdFx0VG9vbHRpcFthY3Rpb25dKCdtb3VzZW91dCcsIGRlbGF5ZWRIaWRlKTtcclxuXHRcdFNMT1RTLkNsb3NlQnV0dG9uW2FjdGlvbl0oJ2NsaWNrJywgZGlzYWJsZSk7XHJcblx0XHRTTE9UUy5TZXR0aW5nc0J1dHRvblthY3Rpb25dKCdjbGljaycsIG9wZW5TZXR0aW5ncyk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBfZ2V0VHJhbnNmb3JtKCkge1xyXG5cdFx0Y29uc3Qgc2NhbGUgPSBDT05GSUcuWm9vbUZhY3RvciAvIGNvbnRleHQuZGV2aWNlUGl4ZWxSYXRpbztcclxuXHRcdGNvbnN0IHBvc1kgID0gUE9TSVRJT05TW0NPTkZJRy5Qb3NpdGlvblswXV07XHJcblx0XHRjb25zdCBwb3NYICA9IFBPU0lUSU9OU1tDT05GSUcuUG9zaXRpb25bMV1dO1xyXG5cclxuXHRcdGxldCBsZWZ0ID0gcG9zWCAqIC0yNCArIHdpbmRvdy5pbm5lcldpZHRoIC8gc2NhbGUgKiAocG9zWCArIDEpIC8gMiAtIFRvb2x0aXAub2Zmc2V0V2lkdGggLyBzY2FsZSAqIChwb3NYICsgMSkgLyAyO1xyXG5cdFx0bGV0IHRvcCAgPSBwb3NZICogLTI0ICsgd2luZG93LmlubmVySGVpZ2h0IC8gc2NhbGUgKiAocG9zWSArIDEpIC8gMiAtIFRvb2x0aXAub2Zmc2V0SGVpZ2h0IC8gc2NhbGUgKiAocG9zWSArIDEpIC8gMjtcclxuXHJcblx0XHRyZXR1cm4gYHNjYWxlKCR7c2NhbGV9KSB0cmFuc2xhdGVZKCR7dG9wfXB4KSB0cmFuc2xhdGVYKCR7bGVmdH1weClgO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZW5hYmxlKCkge1xyXG5cdFx0Ly8gcmVhZCB0aGUgb3BhY2l0eSB0byBraWNrLXN0YXJ0IHRoZSBpbml0aWFsIENTUyBmYWRlLWluIGFuaW1hdGlvblxyXG5cdFx0Ly8gKGl0IHdvdWxkbid0IG90aGVyd2lzZSBhbmltYXRlIHdoZW4gYWRkaW5nIHRoZSBgLnZpc2libGVgIGNsYXNzIHJpZ2h0IGFmdGVyXHJcblx0XHQvLyBhcHBlbmRpbmcgdGhlIG5vZGUgdG8gdGhlIGJvZHkgLSBtb3N0IGxpa2VseSBiZWNhdXNlIG9mIHNvbWUgQ2hyb21lIGJ1ZylcclxuXHRcdGNvbnRleHQuZ2V0Q29tcHV0ZWRTdHlsZShUb29sdGlwKS5vcGFjaXR5O1xyXG5cclxuXHRcdF90b2dnbGVFdmVudExpc3RlbmVycyh0cnVlKTtcclxuXHRcdC8vc2hvdygpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZGlzYWJsZSgpIHtcclxuXHRcdF90b2dnbGVFdmVudExpc3RlbmVycyhmYWxzZSk7XHJcblx0XHRoaWRlKCkudGhlbigoKSA9PiB7XHJcblx0XHRcdFRvb2x0aXAucmVtb3ZlKCk7XHJcblx0XHRcdFRvb2x0aXAgPSBudWxsO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBvcGVuU2V0dGluZ3MoKSB7XHJcblx0XHRSdW50aW1lLmludm9rZSgnb3Blbi1zZXR0aW5ncycsICcjc2V0dGluZ3MvdG9vbHRpcCcpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2hvdyhhdXRvSGlkZT8pIHtcclxuXHRcdFRvb2x0aXAuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpO1xyXG5cdFx0Y2FuY2VsRGVsYXllZEhpZGUoKTtcclxuXHRcdHVwZGF0ZSgpO1xyXG5cclxuXHRcdGF1dG9IaWRlICE9PSBmYWxzZSAmJiBkZWxheWVkSGlkZSgpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2hvd09uKCkge1xyXG5cdFx0c2hvdyhmYWxzZSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBoaWRlKCkge1xyXG5cdFx0VG9vbHRpcC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7XHJcblx0XHRjYW5jZWxEZWxheWVkSGlkZSgpO1xyXG5cdFx0U1RBVEUuTmVlZHNVcGRhdGUgPSBmYWxzZTtcclxuXHJcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKGRvbmUpID0+IHNldFRpbWVvdXQoZG9uZSwgMzAwKSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBkZWxheWVkSGlkZSgpIHtcclxuXHRcdGNhbmNlbERlbGF5ZWRIaWRlKCk7XHJcblx0XHRTVEFURS5QZW5kaW5nSGlkZSA9IHNldFRpbWVvdXQoaGlkZSwgQ09ORklHLkhpZGVUaW1lb3V0KTtcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGNhbmNlbERlbGF5ZWRIaWRlKCkge1xyXG5cdFx0Y2xlYXJUaW1lb3V0KFNUQVRFLlBlbmRpbmdIaWRlKTtcclxuXHRcdFNUQVRFLlBlbmRpbmdIaWRlID0gbnVsbDtcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIHVwZGF0ZSgpIHtcclxuXHRcdGlmICghVG9vbHRpcC5wYXJlbnROb2RlKSB7XHJcblx0XHRcdGRpc2FibGUoKTtcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICghU1RBVEUuTmVlZHNVcGRhdGUpIHtcclxuXHRcdFx0U1RBVEUuTmVlZHNVcGRhdGUgPSB0cnVlO1xyXG5cdFx0XHRjb250ZXh0LnJlcXVlc3RBbmltYXRpb25GcmFtZShfdXBkYXRlKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIF91cGRhdGUoKSB7XHJcblx0XHRTVEFURS5OZWVkc1VwZGF0ZSA9IGZhbHNlO1xyXG5cclxuXHRcdFRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gX2dldFRyYW5zZm9ybSgpO1xyXG5cclxuXHRcdFNMT1RTLldpbmRvd1dpZHRoLmlubmVySFRNTCAgICA9IGNvbnRleHQuaW5uZXJXaWR0aDtcclxuXHRcdFNMT1RTLldpbmRvd0hlaWdodC5pbm5lckhUTUwgICA9IGNvbnRleHQuaW5uZXJIZWlnaHQ7XHJcblx0XHRTTE9UUy5WaWV3cG9ydFdpZHRoLmlubmVySFRNTCAgPSBjb250ZXh0Lm91dGVyV2lkdGg7XHJcblx0XHRTTE9UUy5WaWV3cG9ydEhlaWdodC5pbm5lckhUTUwgPSBjb250ZXh0Lm91dGVySGVpZ2h0O1xyXG5cclxuXHRcdCFpc1Zpc2libGUoKSAmJiBzaG93KCk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBpc1Zpc2libGUoKSB7XHJcblx0XHRyZXR1cm4gVG9vbHRpcCAmJiBUb29sdGlwLmNsYXNzTGlzdC5jb250YWlucygndmlzaWJsZScpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gaGFuZGxlRXh0ZW5zaW9uUmVxdWVzdChtc2csIHNlbmRlciwgcmVzcG9uZCkge1xyXG5cdFx0aWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnKSB7XHJcblx0XHRcdG1zZyA9IHtjb21tYW5kOiBtc2d9XHJcblx0XHR9XHJcblxyXG5cdFx0c3dpdGNoIChtc2cuY29tbWFuZCkge1xyXG5cdFx0XHRjYXNlICdTVEFUVVMnOlxyXG5cdFx0XHRcdHJlc3BvbmQoaXNWaXNpYmxlKCkgPyAnVklTSUJMRScgOiAnSElEREVOJyk7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnU0VUX0hJREVfREVMQVknOlxyXG5cdFx0XHRcdENPTkZJRy5IaWRlVGltZW91dCA9IG1zZy5kZWxheSB8fCBDT05GSUcuSGlkZVRpbWVvdXQ7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnRElTQUJMRSc6XHJcblx0XHRcdFx0ZGlzYWJsZSgpO1xyXG5cdFx0XHRicmVhaztcclxuXHJcblx0XHRcdGNhc2UgJ1NIT1cnOlxyXG5cdFx0XHRcdHNob3coKTtcclxuXHRcdFx0YnJlYWs7XHJcblxyXG5cdFx0XHRjYXNlICdISURFJzpcclxuXHRcdFx0XHRoaWRlKCk7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnVE9HR0xFJzpcclxuXHRcdFx0XHRpc1Zpc2libGUoKSA/IGhpZGUoKSA6IHNob3coKTtcclxuXHRcdFx0YnJlYWs7XHJcblx0XHR9XHJcblx0fVxyXG59KSh0aGlzKTtcclxuIl19
