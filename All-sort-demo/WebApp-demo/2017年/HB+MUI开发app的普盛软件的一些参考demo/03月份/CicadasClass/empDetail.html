<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<meta name="Keywords" content="知了云课堂" />
		<meta name="Description" content="知了云课堂" />
		<title>知了云课堂</title>
		<link rel="stylesheet" href="css/mui.min.css" />
		<!--<link rel="stylesheet" href="css/base.css" />-->
		<link rel="stylesheet" href="css/common.css" />
		<script type="text/javascript" src="js/flexible.debug.js"></script>
		<script type="text/javascript" src="js/flexible_css.debug.js"></script>
	</head>
	<style>
		html,
		body {
			min-height: 100%;
			background-color: #efeff4;
		}
		.emp-top {
			background: url(img/muwu.jpg) no-repeat 100%;
			height: 190px;
			background-size: cover;
		}
		
		.emp-avatar img {
			width: 100px;
			height: 100px;
			z-index: 9999;
			border-radius: 50%;
			display: block;
			margin: auto;
		}
		
		.emp-avatar h5 {
			text-align: center;
			font-size: 0.37rem;
			color: #fff;
			margin: 15px 0 0 35px;
		}
		
		.add-table {
			width: 100%;
			background: #fff;
			margin-bottom: 10px;
		}
		
		.add-table tr {
			line-height: 1.2rem;
			border-bottom: 1px solid #ddd;
			height: 1.2rem;
		}
		
		.add-table tr>td {
			font-size: .4rem;
			padding-left: .4rem;
			overflow: hidden;
		}
		
		.add-table tr>td:nth-child(2) {
			color: #333;
			width: 70%
		}
		
		.add-table tr>td:nth-child(3) {
			color: #333;
			width: 5%
		}
		
		.add-table tr>td>img {
			width: .2rem;
			margin: .4rem
		}
		
		.add-table tr>td>input {
			border: none;
			outline: none;
			width: 100%;
			margin: -0.1rem 0 0 0;
			padding: 0;
		}
		
		.add-table tr>td>textarea {
			-webkit-appearance: none;
			height: 2.2rem;
			box-sizing: border-box;
			width: 6.2rem;
			padding: .2rem;
			font-size: .4rem;
			border: 1px solid #ddd;
			margin: .2rem 0;
		}
		
		
		.radio-check{width:.5rem;height:.5rem;background:url(img/radio_normal.png) no-repeat;background-size:contain;float:left;margin-left:.5rem;margin-top:.08rem}
		.radio-check.active{background:url(img/radio_checked.png) no-repeat;background-size:contain;}
		/* 向左右浮动的时候，同时解决 IE6 下的双边距问题 */
		.left {
			float:left;
			*display:inline;
		}
		
		.add-foot {
			position: fixed;
			bottom: 0;
			left: 0;
			height: 1.3333rem;
			line-height: 1.3333rem;
			background: #fff;
			width: 100%;
		}
		
		.add-foot>button {
			text-align: center;
			line-height: 1.3333rem;
			font-size: .45rem;
			color: #fff;
			background: #3496F9;
			width: 49.9%;
			border: 1px solid #ddd;
		}
		
		.add-foot>button:active {
			text-align: center;
			line-height: 1.3333rem;
			font-size: .45rem;
			color: #fff;
			background: #1A75D1;
			width: 49.9%;
			border: 1px solid #ddd;
		}
		a , a:hover{
			text-decoration: none;
		}
		
	</style>

	<body>
		<div class="emp-top">
			<header class="mui-bar mui-bar-nav" style="position: static;background-color: transparent;">
				<h1 id="title" class="mui-title cc-title"><span></span></h1>
				<div class="mui-pull-left">
					<a id="back" class="mui-icon">
						<img src="img/title_button_back.png" style="width:1em;height:1em;" />
					</a>
				</div>
			</header>
			<div class="emp-avatar">
				<a href="#picture">
					<img src="img/default_photo.png" id="head-img" ></img>
				</a>
				<!--<h5>POSUN</h5>-->
			</div>
		</div>
		<div style="height:16rem;overflow-y:auto;" id="emp">
			<section>
				<table class="add-table">
					<tr>
						<td>部门</td>
						<td colspan="2"><input id="orgName" type="text" placeholder="" maxlength="10" disabled="disabled" value="{{emp.empOrgName}}" /></td>
					</tr>
					<tr>
						<td>姓名</td>
						<td><input v-model="emp.empName" id="empName" type="text" placeholder="" maxlength="10" value="{{emp.empName}}" /></td>
						<td><img src="img/editl.png" style="width:.3rem;vertical-align:middle" /></td>
					</tr>

					<tr>
						<td>姓别</td>
						<template v-if="isMale">
							<td colspan="2">
								<div class="radio-check left Elevator active" style="margin-top:.35rem;margin-left:.1rem;"></div><span data-ele="1" class="left" style="margin-left:.2rem;">男</span>
								<div class="radio-check left Elevator" style="margin-top:.35rem;"></div><span data-ele="2" class="left" style="margin-left:.2rem;">女</span>
							</td>
						</template>
						<template v-else>
							<td colspan="2">
								<div class="radio-check left Elevator " style="margin-top:.35rem;margin-left:.1rem;"></div><span data-ele="1" class="left" style="margin-left:.2rem;">男</span>
								<div class="radio-check left Elevator active" style="margin-top:.35rem;"></div><span data-ele="2" class="left" style="margin-left:.2rem;">女</span>
							</td>
						</template>
					</tr>
					<tr>
						<td>电话</td>
						<td>
							<input v-model="emp.workPhone" id="workPhone" type="tel" placeholder="" maxlength="15" value="{{emp.workPhone}}" />
						</td>
						<td><img src="img/editl.png" style="width:.3rem;vertical-align:middle" /></td>
					</tr>
					<tr>
						<td>手机</td>
						<td>
							<input v-model="emp.mobilePhone" id="mobilePhone" type="tel" placeholder="" maxlength="15" value="{{emp.mobilePhone}}" />
						</td>
						<td><img src="img/editl.png" style="width:.3rem;vertical-align:middle" /></td>
					</tr>
					<tr>
						<td>邮箱</td>
						<td>
							<input v-model="emp.email" id="email" type="email" placeholder="" maxlength="30" value="{{emp.email}}" />
						</td>
						<td><img src="img/editl.png" style="width:.3rem;vertical-align:middle" /></td>
					</tr>
					<tr>
						<td>职位</td>
						<td>
							<input v-model="emp.position" id="idcard" type="text" placeholder="" maxlength="30" value="{{emp.position}}" />
						</td>
						<td><img src="img/editl.png" style="width:.3rem;vertical-align:middle" /></td>
					</tr>

				</table>

				<table class="add-table">

					<tr>
						<td>等级</td>
						<td>
							<input v-model="emp.empLevel" id="" type="text" placeholder="" maxlength="30" disabled="disabled" value="{{emp.empLevel}}" />
						</td>
							<td><img  style="width:.3rem;vertical-align:middle;visibility: hidden;" /></td>
					</tr>
					<tr>
						<td>经验</td>
						<td colspan="2">
							<input v-model="emp.empExperience" id="" type="text" placeholder="" maxlength="30" disabled="disabled" value="{{emp.empExperience}}" />
						</td>
					</tr>
					<tr>
						<td>能量</td>
						<td colspan="2">
							<input v-model="emp.empEnergy" id="" type="text" placeholder="" maxlength="30" disabled="disabled" value="{{emp.empEnergy}}" />
						</td>
					</tr>
					<tr>
						<td>金币</td>
						<td colspan="2">
							<input v-model="emp.gold" id="" type="text" placeholder="" maxlength="30" disabled="disabled" value="{{emp.gold}}" />
						</td>
					</tr>
				</table>
			</section>

			<footer class="add-foot" >
				<button id="save" style="width:100%;">保存</button>
			</footer>
		</div>
		
		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#" open-type="1">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#" open-type="2">从相册中选择</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture" open-type="0"><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="js/zepto1.1.6.min.js"></script>
	<script src="js/mui.min.js"></script>
	<script src="js/locStorage.js"></script>
	<script type="text/javascript" src="js/vue.min.js"></script>
	<script src="js/url.js"></script>
	<script src="js/common.js"></script>
	<script type="text/javascript">
		var empId=localStorage.getItem($.locStorage.emp.empId);
		var VM = new Vue({
			el: '#emp',
			data: {
				emp: {
					empOrgName: localStorage.getItem($.locStorage.emp.empOrgName),
					empName: localStorage.getItem($.locStorage.emp.empName),
					empId: localStorage.getItem($.locStorage.emp.empId),
					sex: localStorage.getItem($.locStorage.emp.sex),
					workPhone: localStorage.getItem($.locStorage.emp.workPhone),
					mobilePhone: localStorage.getItem($.locStorage.emp.mobilePhone),
					email: localStorage.getItem($.locStorage.emp.email),
					idCard: localStorage.getItem($.locStorage.emp.idCard),
					headPortrait: localStorage.getItem($.locStorage.emp.headPortrait),
					position: localStorage.getItem($.locStorage.emp.position),
					empLevel: '',
					empExperience: '',
					empEnergy: '',
					gold: ''
				}
			},
			methods: {},
			computed: {
				isMale: function() {
					console.log(this.emp.sex);
					if(this.emp.sex == "1") { //男
						return 1
					} else { //女
						return 0
					}
				}
			},
		});

		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
		if(mui.os.plus) {
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var empLevel = self.empLevel;
				var empExperience = self.empExperience;
				var empEnergy = self.empEnergy;
				var gold = self.gold;
				VM.emp.empLevel = 'Lv' + empLevel;
				VM.emp.empExperience = empExperience;
				VM.emp.empEnergy = empEnergy;
				VM.emp.gold = gold;
			});
		} else {
			mui.ready(function() {
				var self = plus.webview.currentWebview();
			});
		}
		
		mui('body').on('shown', '.mui-popover', function(e) {
			console.log('shown', e.detail.id);//detail为当前popover元素
		});
		mui('body').on('hidden', '.mui-popover', function(e) {
			console.log('hidden', e.detail.id);//detail为当前popover元素
		});
		var headImg;
		var send = function(msg) {
						console.log(msg.content);
						headImg=msg.content;
						document.getElementById("head-img").src = headImg;
					};
		var localUrl;			
		mui('body').on('tap', '.mui-popover-action li>a', function() {
			var a = this,parent;
			//根据点击按钮，反推当前是哪个actionsheet
			for (parent = a.parentNode; parent != document.body; parent = parent.parentNode) {
				if (parent.classList.contains('mui-popover-action')) {
					break;
				}
			}
			//关闭actionsheet
			mui('#' + parent.id).popover('toggle');
			console.log("你刚点击了\"" + a.innerHTML + "\"按钮");
			var type = a.getAttribute('open-type');
			var dataStr=new Date().getTime();
			if(type == 1) {
				var cmr = plus.camera.getCamera();
				console.log( "Camera supperted image formats: " + cmr.supportedImageFormats );
				var res = cmr.supportedImageResolutions[0];//字符串数组，摄像头支持的拍照分辨率
				var fmt = cmr.supportedImageFormats[0];//字符串数组，摄像头支持的拍照文件格式
				//  file:///storage/emulated/0/Android/data/io.dcloud.HBuilder/.HBuilder/apps/HBuilder/doc/img/10001_1488351938382.jpg 
				var path = "_doc/img/"+dataStr+"."+fmt;
				cmr.captureImage(function(path) {
					console.log("1111111111"+path);
					VM.emp.headPortrait = "/upload/"+empId+"/"+path.replace("_",'');
					alert(VM.emp.headPortrait);
					localUrl = path;
					console.log("2222222222"+plus.io.convertLocalFileSystemURL(path));//将本地URL路径转换成平台绝对路径
					send({
						sender: 'self',
						type: 'image',
						content: "file://" + plus.io.convertLocalFileSystemURL(path)
					});
				}, function(err) {},{filename:path,resolution:res,format:fmt});
			} else if(type == 2) {
				plus.gallery.pick(function(path) {
					console.log("3333333333"+path);
					//_doc/img/
					VM.emp.headPortrait = "/upload/"+empId+"/"+ path;
					send({
						sender: 'self',
						type: 'image',
						content: path
					});
				}, function(err) {}, null);
			}
			});
			
			var clientEmp = {};
			//保存个人信息修改
			$("#save").on("tap", function() {
				console.log(JSON.stringify(VM.emp));
				if($("#empName").val() == "") {
					mui.toast("请您输入姓名！");
					return
				};
				if(!/^[\u4e00-\u9fa5]+$/.test($("#empName").val())) {
					mui.toast("请您输入中文名称！");
					return
				};
				if(!(/^1[3|4|5|7|8]\d{9}$/.test($("#mobilePhone").val()))) {
					mui.toast("您输入的手机号有误！");
					return
				};
				
				if($("#mobilePhone").val() == "" && $("#workPhone").val() == "") {
					mui.toast("固定电话/手机至少输入一项！");
					return;
				}
				if(isDefine(headImg)){//上传文件接口
					uploadImg(headImg);
				}
				var url = $.url.userSave;
				console.log("修改个人信息：" + url);
				clientEmp.id = VM.emp.empId;
				clientEmp.empName = VM.emp.empName;
				clientEmp.sex = VM.emp.sex;
				clientEmp.workPhone = VM.emp.workPhone;
				clientEmp.mobilePhone = VM.emp.mobilePhone;
				clientEmp.email = VM.emp.email;
				clientEmp.headPortrait = VM.emp.headPortrait;
				
				$.marketApi.ajaxRequest({
						type: "POST",
						url: url,
						data: JSON.stringify(clientEmp),
						callback: function(data) {
							console.log(JSON.stringify(data));
							//if(data.status){
								mui.toast(data.msg);
							//}
						
						},
						errorCallback: function(xhr, errorType, error, msg) {
							alert(msg);
						}
					});
				
				
				
			});
			
			function uploadImg(path){//绝对路径
				var server = getHost()+$.url.fileUpload;
				var wt=plus.nativeUI.showWaiting();
				var task=plus.uploader.createUpload(server,
					{method:"POST"},
					function(t,status){ //上传完成
						if(status==200){
							mui.toast("图片上传成功!");
							console.log(status+"："+t.responseText)
							wt.close();
						}else{
							mui.toast("上传失败："+status);
							console.error(status+"："+t.responseText)
							wt.close();
						}
					}
				);
				task.setRequestHeader("auth",getAuth());
				task.addData("name",localUrl);
//				task.addData("id","localUrl");
//				task.addData("key","localUrl");
				var fileName = path.substring(path.lastIndexOf("/")+1);
				console.log(""+path);
				console.log(""+fileName);
				
				var filedir = path;
				if(path.indexOf('doc')!= -1){
					 filedir = path.substring(path.indexOf('doc'));
				}
				console.log("filedirssss："+filedir);
				console.log("path："+path);
				task.addFile(localUrl,{key:fileName,name:fileName,mime:'image/jpeg'});
				task.start();
			}

			//选择性别
			$(".Elevator").on("tap", function() {
//				获得匹配集合中每个元素的同胞，通过选择器进行筛选是可选的。
//				查找每个 p 元素的所有类名为 "selected" 的所有同胞元素：
//				$("p").siblings(".selected")
				$(this).addClass("active").siblings("div").removeClass("active");
				console.log($(this).next().data("ele"));
//				next() 获得匹配元素集合中每个元素紧邻的同胞元素。如果提供选择器，则取回匹配该选择器的下一个同胞元素。
//				data() 方法向被选元素附加数据，或者从被选元素获取数据。
				VM.emp.sex = $(this).next().data("ele");
			});
			
			mui.back = function() {
		    	mui.currentWebview.hide('pop-out');
			}
			$(".mui-pull-left").on('tap', function() {
				mui.back();
			});
	</script>

</html>