<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>创建任务</title>
		<!-- Mobile Devices Support @begin -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible.js" type="text/javascript"></script>
		<script src="../js/flexible_css.js" type="text/javascript"></script>
		<!-- Mobile Devices Support @end -->
		<link rel="stylesheet" href="../css/base-reset.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/mui.picker.all.css" />
		<link rel="stylesheet" type="text/css" href="../css/swiper-3.3.1.min.css">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/yhn.css">
	</head>
	<style>
		.mui-table-view-cell{margin:0;padding: 0;}
		.swiper-container {
	        width: 100%;
	        min-height: 4rem;
	        height:auto;
	        border-bottom: 1px solid #dddddd;
	        background:#fff;
	    }
	   .y-swiper1 {
	        text-align: center;
	        background:url(../images/img-shadow.png) no-repeat;
	        background-size:2.5rem 2.5rem;
	        background-position: .4rem .3rem;
	        
	    }
	    
	    .y-swiper1>img{display:block;width:2.5rem;height:2.5rem;margin:.5rem auto .15rem;}
	    
	    
	    .y-swiper2>img{display:block;width:2.5rem;height:2.5rem;margin:.5rem auto .15rem;}
	    .y-swiper2>p{text-align: center;}
	    .y-swiper2>div{display:none;position:absolute;top:.2rem;right:-.3rem;width:1rem;height:1rem;}
	    .y-swiper2>div.active{display:block}

	    .y-imgListBox{height:4rem;border-bottom:1px solid #ddd;background:#fff;overflow:hidden}
	    .y-imgListBox>aside{width:2.4rem;height:}
	    .y-imgListBox>aside>img{display:block;width:1.5rem;margin:.5rem auto;}
	    .y-imgListBox>aside>h1{text-align: center;font-size:.45rem;margin-top:.35rem}
	    .y-imgListBox>aside>p{text-align: center;font-size:.4rem;}
	    
	    .y-imgListBox>div{width:7.6rem;float:right;height:4rem;position:absolute;left:2.4rem;overflow:hidden}

	    .y-pingjia>h1>strong{display:none}
	    .y-pingjia>h1>.active{display:inline}
	    .y-pingjia>h1>.ontap{opacity: .6;}
	    .queren-btn{
	    	position: absolute;
	    	bottom:0.167rem;
	    	left:3.4rem !important;
	    	width:4.0rem !important;
			height:1.067rem !important;
			line-height: 1.067rem !important;

			text-align: center;
			background-color: #eb6d00;
			color:white;
			font-size: 0.4rem;
			border-radius: 0.133rem;
	    }

	    .y-imgListBox>aside{width:2.4rem;height:}
	    .y-imgListBox>aside>img{display:block;width:1.5rem;margin:.5rem auto;}
	    .y-imgListBox>aside>h1{text-align: center;font-size:.45rem;margin-top:.35rem}
	    .y-imgListBox>aside>p{text-align: center;font-size:.4rem;}
	    
	    .y-imgListBox>div{width:7.6rem;float:right;height:4rem;position:absolute;left:2.4rem !important;overflow:hidden}
	    .y-pingjia>h1>strong{display:none}
	    .y-pingjia>h1>.active{display:inline}
	    .y-pingjia>h1>.ontap{opacity: .6;}
	    .weiqueren{
	    	color:#eb6d00;
	    	font-size: 0.38rem;
	    }
	    .weiqueren.yiqueren{
	    	color:#aaaaaa;
	    }
	    .queren-btn{
	    	position: absolute;
	    	bottom:0.167rem;
	    	left:3.4rem !important;
	    	width:4.0rem !important;
			height:1.067rem !important;
			line-height: 1.067rem !important;

			text-align: center;
			background-color: #eb6d00;
			color:white;
			font-size: 0.4rem;
			border-radius: 0.133rem;
	    }
	    .querenspan{
	    	width:1.833rem;
	    	height:0.667rem;
	    	line-height: 0.667rem;
	    	text-align: center;
	    	border-radius: 0.133rem;
	    	color:white;
	    	font-size: 0.4rem;
	    	background-color: #eb6d00;
	    	display: inline-block;
	    	margin-left: 0.267rem;
	    	margin-top:  0.267rem;
	    }

	    .querenspan:active{
	    	background-color: #cf7528;
	    }
	    .querenwen{
	        width:1.833rem;
	    	height:0.667rem;
	    	line-height: 0.667rem;
	    	text-align: center;
	    	color:#eb6d00;
	    	font-size: 0.4rem;
	    	/*background-color: #eb6d00;*/
	    	display: inline-block;
	    	margin-left: 0.267rem;
	    	margin-top:  0.267rem;	
	    }

	    .y-swiper1 {
		     /*background: none !important;*/
		}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<span class="title">图纸管理</span>
		</header>

		<!-- 页面加载的loading 效果  -->
	    <div v-show='showloading'  class="loader">
	        <div class="loader-inner ball-spin-fade-loader">
	            <div></div>
	            <div></div>
	            <div></div>
	            <div></div>
	            <div></div>
	            <div></div>
	            <div></div>
	            <div></div>
	        </div>
	    </div>

		<section v-show='!showloading' class="under-top" >

			<div class="y-pingjia" style="background:#fff">
				<h1>
					<span></span>
					设计图
					<!-- <strong id="addclass1" class="right" style="display:block">新增</strong> -->
				</h1>
			</div>
			
			<div class="swiper-container">
				<div class="swiper-wrapper">
					<div class="swiper-slide y-swiper1" v-for="(index,key) in dataArr[0].sitesDrawVoList" >

						<img @tap="goToPath(key,'0',index)" src="{{key.sitesDrawingList[0].pictureUrl | formatURL}}" alt="" />
						<p style='height:auto'>{{key.drawType}}({{key.sitesDrawingList.length}})</p>

						<!-- <p v-show="key.sitesDrawingList[0].stateName =='已确认' " style='color:#eb6d00;'>已确认</p> -->

						<p v-show="isqueren(key)" style='color:#eb6d00;'>已确认</p>

					</div>
				</div>
			</div>
			
			<div>
				<div class="y-pingjia" style="background:#fff;">
					<h1>
						<span></span>
						商品定制图
						<!-- <strong class="right active" id="addclass2">新增</strong> -->
						<!--<strong class="right active" id="y-edit" style="color:#666">编辑</strong>-->
						<strong class="right" id="y-cance" style="color:#666">取消</strong>
						<strong class="right" id="y-save" style="color:#1D88DC">保存</strong>
					</h1>
				</div>
				
				<div class="y-imgListBox"   v-for="(index,key) in dataArr[1].sitesDrawVoList" >

					<aside class="left">
						<!--<img src="../images/icon-jia.png" alt="" />-->
						<h1 style="margin-top:1.6rem"  @click="goToPath(key,'1',index)">{{key.drawType}}</h1>

						<!-- <span  class='querenspan' v-show="key.sitesDrawingList.length>0 && key.sitesDrawingList[0].stateName == '未确认' && key.sitesDrawingList[0].stateName !== undefined  && postNo == '50' "  @click='tuzhiqueren(key)'>确认</span> -->

						<span  class='querenspan' v-show="key.sitesDrawingList.length>0 && !isqueren(key)  && key.sitesDrawingList[0].stateName !== undefined  && postNo == '50' "  @click='tuzhiqueren(key)'>确认</span>

						<!-- <span  class='querenwen' v-show="key.sitesDrawingList.length>0 && key.sitesDrawingList[0].stateName == '已确认'"  >已确认</span> -->

						<span  class='querenwen' v-show="key.sitesDrawingList.length>0 && isqueren(key) "  >已确认</span>


						<span  class='querenwen' v-show="key.sitesDrawingList.length == 0 && !isqueren(key) "   @click="goToPath(key,'1',index)">点击上传图纸</span>

						<p></p>
 
					</aside>
					
					<div class="swiper-container1" style='height:auto;'>
						<div class="swiper-wrapper" style='height:auto;' @click="goToPath(key,'1',index)">
							<div style='margin-top: 5px;' class="swiper-slide y-swiper2" v-for="item in key.sitesDrawingList">
								<img  src="{{item.pictureUrl|formatURL}}" alt ="" />
								<p>{{item.drawingName}}</p>
							</div>

						</div>
					</div>

				</div>

			</div>
		</section>
	</body>
	<script src="../js/public.js"></script>
	<script src="../js/swiper-3.3.1.min.js"></script>
	<script src="../js/zepto1.1.6.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../js/vue.min.js"></script>
	<script src="../js/global.js"></script>
<script>
		var swiper = new Swiper('.swiper-container', {
	        pagination: '.swiper-pagination',
	        slidesPerView: 3,
	        paginationClickable: true,
	        spaceBetween: 0,
	        freeMode: true
	    });
	    
	    var swiper1=null;
	    
	    function makeSwiper(){
	    	setTimeout(function(){
		   	 	swiper1 = new Swiper('.swiper-container1', {
					pagination: '.swiper-pagination',
					slidesPerView: 2.5,
					paginationClickable: true,
					spaceBetween: 0,
					freeMode: true
				});
		   	},10);
	    }
	    
	    
	    var vm = new Vue({
			el: 'body',
			data: {
				arr1:[
				],
				dataArr:null,
				showloading:true,
				shejiID:'',
				dingzhiID:'',
				postNo:'',
				querenClick:true

			},
			methods: {
				delImg: function(arr,index) {
					console.log(index);
					arr.splice(index, 1);
					this.$nextTick(function(){
						changeSwiper();
					});
				},
				addImg:function(arr){
					console.log(arr);
					var num=arr.length+1
					var obj={};
					obj.drawingName=""+num;
					obj.createTime="2017-4-13";
					obj.drawingType=""+num;
					obj.id=""+num;
					obj.pictureUrl=""+num;
					obj.pictureVersion=""+num;
					obj.sitesId=""+num;
					obj.state=""+num;
					obj.stateName=""+num;
					
					arr.push(obj);
					
					changeSwiper();
				},
				goToPath:function(key,parentInd,arrInd){
					console.log(JSON.stringify(key));
					console.log(parentInd);
					console.log(arrInd);

					localStorage.paperSonData=JSON.stringify(key);
					localStorage.paperParentInd=parentInd;
					localStorage.paperarrInd=arrInd;

					localStorage.tuzhiidqueren=key.id;

					if(parentInd == '0'){
						localStorage.shejiID=this.shejiID;
					}else{
						localStorage.shejiID=this.dingzhiID;
					}
					// localStorage.dingzhiID=this.dingzhiID;

					console.log(localStorage.parentId)

					console.log(JSON.stringify( key) )

					openNew("photoList.html");
				},
				tuzhiqueren:function(key){
					console.log(JSON.stringify( key))

					var  id=key.id;
					var sitesId=key.sitesDrawingList[0].sitesId;
					console.log(sitesId)
					tuzhiqueren(id,sitesId);
				},
				isqueren:function(key){
					var arr=key.sitesDrawingList;
					console.log('eeeeeeeee')
					console.log(logJson(arr))
					var querenflag=false;

					if(arr.length > 0){
						for(var i=0;i<arr.length;i++){
							if(arr[i].stateName !== '已确认'){
	                            querenflag=false;
	                            break
							}else{
								querenflag=true;
							}
						}
					}else{
						querenflag=false;
					}
					return querenflag
				}
			},
			ready: function() {
				init()
				this.postNo=localStorage.postNo;
			}
		});

		function tuzhiqueren(id,sitesId){

			if(vm.querenClick){

				vm.querenClick=false;

				mui.ajax(getBaseServerUrl() + '/sites/sitesDrawing/updateSitesDrawing', {
					type: 'post', //HTTP请求类型
					dataType: 'json',
					headers: {
						"auth": localStorage.headParam
					},
	                contentType: "application/json",
					data: {
						sitesId:sitesId,
                        sitesDrawingTypeId:id,
					},
					success: function(jsonData) {
						 if(jsonData.status =='true'){
						 	console.log(jsonData)

						 	plus.nativeUI.alert('图纸确认成功',function(){
						 		init()
						 		vm.querenClick=true;
						 	});

						 	vm.querenClick=false;

						 }else{
						 	alert(jsonData.msg)
						 	vm.querenClick=false;
						 }
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
					}
			    });

			}

			
		}
		
		Vue.filter('formatURL', function(value) {
			if(value == null|| value== undefined || value == ""){
				return "../images/icon-jiahao.png"
			}else{
				return getBaseImgUrl()+value
			}
		});
		
		
		$(".y-pingjia>h1>strong").on("touchstart",function(){
			$(this).addClass("ontap");
		});
		
		$(".y-pingjia>h1>strong").on("touchend",function(){
			$(this).removeClass("ontap");
		});
		
		$("#y-edit").on("tap",function(){
			$("#y-edit,#y-add").removeClass("active");
			$("#y-cance,#y-save").addClass("active");
			$(".y-swiper2>div").addClass("active");
		});
		
		$("#y-cance,#y-save").on("tap",function(){
			$("#y-cance,#y-save").removeClass("active");
			$("#y-edit,#y-add").addClass("active");
			$(".y-swiper2>div").removeClass("active");
		});
		var swiper1=null;
		    
		
		function changeSwiper(){
			//mySwiper.destroy(false)
			console.log(swiper)
			setTimeout(function(){
				swiper.updateSlidesSize();
			},500);
			for(var i=0;i<swiper1.length;i++){
				swiper1[i].updateSlidesSize();
			}
			//swiper1.updateSlidesSize();
//			swiper1 =new Swiper('.swiper-container1', {
//		        pagination: '.swiper-pagination',
//		        slidesPerView: 2.5,
//		        paginationClickable: true,
//		        spaceBetween: 0,
//		        freeMode: true
//		    });
		}
			console.log(localStorage.selectSitesId)
		    function init() {
				//获取工地信息
				mui.ajax(getBaseServerUrl() + '/sites/sitesDrawing/querySitesDrawingAllForAPP', {
					type: 'get', //HTTP请求类型
					headers: {
						"auth": localStorage.headParam
					},
					data: {
						sitesId:localStorage.selectSitesId
					},
					success: function(jsonData) {
						console.log(jsonData)
						 
						if(jsonData.status===true){

							vm.showloading=false;
							vm.dataArr =jsonData.other.drawlist;

							shejiID=vm.dataArr[0].id;
							vm.shejiID=shejiID;
							console.log("vvvvvvvvvvv")
							console.log(vm.shejiID)

							dingzhiID=vm.dataArr[1].id;

							console.log("eeeeeeeee")
							console.log(JSON.stringify( vm.dataArr[1]) )
							vm.dingzhiID=dingzhiID

							makeSwiper();

							jiancheTuzhi()

						}
						setTimeout(function(){
							swiper.updateSlidesSize();
						},500);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
					}
				});
			}
			function jiancheTuzhi(){

				var shiejiArr=vm.dataArr[0].sitesDrawVoList;
				var querenFlag=false;

				for( var i=0;i<shiejiArr.length;i++){
					if( shiejiArr[i].sitesDrawingList.length >1 &&  shiejiArr[i].sitesDrawingList[0].stateName=='未确认'){

						querenFlag=true;

					}else{
                        querenFlag=false;
                        break;
					}
			    }
			    if(querenFlag){
                    
                    if(window.plus) {
						plusReadytuzhi()
					} else {
						document.addEventListener('plusready', plusReadytuzhi, false);
					}

					function plusReadytuzhi(){

						plus.nativeUI.confirm( "点击确认则关闭上传图纸任务", function(e){

				            //  e.index == 0 表示的是  点击 的 是 确定按钮
				            //  要 执行  登录退出 操作
				            if( e.index == 0){
				              querentuzhiU()
				            }
				            else{
				            
				            }
				        } );

					}
			    }

			}

			function querentuzhiU(){

				mui.ajax(getBaseServerUrl() + '/sites/sitesTask/updateDrawingTask', {
					dataType: 'json',
					headers: {
					   "auth": localStorage.headParam
					},
					contentType: "application/json",
					data:{ 
						sitesId:localStorage.selectSitesId,
                        empId:localStorage.empId
					},
					type: 'post',
					success: function(jsonData) {
						 
						 if(jsonData.status == 'true'){
						 	console.log(JSON.stringify(jsonData))
						 	plus.nativeUI.alert(jsonData.msg);
						 }else{
                            plus.nativeUI.alert(jsonData.msg);
						 }

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {}
				});
			}
			
		
			// $(addclass1).on("tap",function(){
			// 	localStorage.addClassID=1;

			// 	localStorage.tuzhiID=vm.shejiID;
			// 	openNew("createPaperClass.html");
			// });
			
			// $(addclass2).on("tap",function(){
			// 	localStorage.addClassID=2;

			// 	localStorage.tuzhiID=vm.dingzhiID;

			// 	openNew("createPaperClass.html");
			// });

		/*$(d1).click(function(){
			init();
		});*/
		
	</script>
</html>
